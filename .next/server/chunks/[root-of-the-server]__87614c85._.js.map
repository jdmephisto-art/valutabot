{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/api/cbr/metals/route.ts"],"sourcesContent":["import { NextResponse, type NextRequest } from 'next/server';\nimport { parseStringPromise } from 'xml2js';\nimport { format, subDays } from 'date-fns';\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = request.nextUrl;\n  const dateFrom = searchParams.get('date_req1'); // dd.mm.yyyy\n  const dateTo = searchParams.get('date_req2');   // dd.mm.yyyy\n\n  const todayStr = format(new Date(), 'dd.MM.yyyy');\n  const fromDate = dateFrom || format(subDays(new Date(), 7), 'dd.MM.yyyy');\n  const toDate = dateTo || todayStr;\n\n  const url = `http://www.cbr.ru/scripts/xml_metall.asp?date_req1=${fromDate}&date_req2=${toDate}`;\n\n  try {\n    const apiResponse = await fetch(url, {\n      headers: { 'Accept': 'application/xml' },\n      cache: 'no-store'\n    });\n\n    if (!apiResponse.ok) {\n        return NextResponse.json({ error: `CBR Metals API failed` }, { status: apiResponse.status });\n    }\n\n    const buffer = await apiResponse.arrayBuffer();\n    const decoder = new TextDecoder('windows-1251');\n    const xmlText = decoder.decode(buffer);\n\n    const jsonData = await parseStringPromise(xmlText);\n    \n    if (dateFrom && dateTo) {\n        return NextResponse.json(jsonData);\n    }\n\n    const rates: Record<string, number> = {};\n    if (jsonData?.Metall?.Record) {\n        const records = Array.isArray(jsonData.Metall.Record) ? jsonData.Metall.Record : [jsonData.Metall.Record];\n        const sortedRecords = [...records].sort((a: any, b: any) => {\n            const dateA = a.$.Date.split('.').reverse().join('');\n            const dateB = b.$.Date.split('.').reverse().join('');\n            return dateA.localeCompare(dateB);\n        });\n\n        sortedRecords.forEach((rec: any) => {\n            const code = rec.$.Code;\n            if (rec.Buy && rec.Buy[0]) {\n                const price = parseFloat(rec.Buy[0].replace(',', '.'));\n                rates[code] = price;\n            }\n        });\n    }\n    \n    return NextResponse.json(rates);\n\n  } catch (error: any) {\n    console.error('Failed to fetch metals from CBR:', error);\n    return NextResponse.json({ error: 'Failed to fetch metals from CBR' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAAA;;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,MAAM,EAAE,YAAY,EAAE,GAAG,QAAQ,OAAO;IACxC,MAAM,WAAW,aAAa,GAAG,CAAC,cAAc,aAAa;IAC7D,MAAM,SAAS,aAAa,GAAG,CAAC,cAAgB,aAAa;IAE7D,MAAM,WAAW,IAAA,kKAAM,EAAC,IAAI,QAAQ;IACpC,MAAM,WAAW,YAAY,IAAA,kKAAM,EAAC,IAAA,oJAAO,EAAC,IAAI,QAAQ,IAAI;IAC5D,MAAM,SAAS,UAAU;IAEzB,MAAM,MAAM,CAAC,mDAAmD,EAAE,SAAS,WAAW,EAAE,QAAQ;IAEhG,IAAI;QACF,MAAM,cAAc,MAAM,MAAM,KAAK;YACnC,SAAS;gBAAE,UAAU;YAAkB;YACvC,OAAO;QACT;QAEA,IAAI,CAAC,YAAY,EAAE,EAAE;YACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,CAAC,qBAAqB,CAAC;YAAC,GAAG;gBAAE,QAAQ,YAAY,MAAM;YAAC;QAC9F;QAEA,MAAM,SAAS,MAAM,YAAY,WAAW;QAC5C,MAAM,UAAU,IAAI,YAAY;QAChC,MAAM,UAAU,QAAQ,MAAM,CAAC;QAE/B,MAAM,WAAW,MAAM,IAAA,+JAAkB,EAAC;QAE1C,IAAI,YAAY,QAAQ;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;QAC7B;QAEA,MAAM,QAAgC,CAAC;QACvC,IAAI,UAAU,QAAQ,QAAQ;YAC1B,MAAM,UAAU,MAAM,OAAO,CAAC,SAAS,MAAM,CAAC,MAAM,IAAI,SAAS,MAAM,CAAC,MAAM,GAAG;gBAAC,SAAS,MAAM,CAAC,MAAM;aAAC;YACzG,MAAM,gBAAgB;mBAAI;aAAQ,CAAC,IAAI,CAAC,CAAC,GAAQ;gBAC7C,MAAM,QAAQ,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,OAAO,GAAG,IAAI,CAAC;gBACjD,MAAM,QAAQ,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,OAAO,GAAG,IAAI,CAAC;gBACjD,OAAO,MAAM,aAAa,CAAC;YAC/B;YAEA,cAAc,OAAO,CAAC,CAAC;gBACnB,MAAM,OAAO,IAAI,CAAC,CAAC,IAAI;gBACvB,IAAI,IAAI,GAAG,IAAI,IAAI,GAAG,CAAC,EAAE,EAAE;oBACvB,MAAM,QAAQ,WAAW,IAAI,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,KAAK;oBACjD,KAAK,CAAC,KAAK,GAAG;gBAClB;YACJ;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAE3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkC,GAAG;YAAE,QAAQ;QAAI;IACvF;AACF","debugId":null}}]
}